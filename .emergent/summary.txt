<analysis>
The AI engineer's work trajectory outlines an iterative development process for a full-stack B2B travel portal. Initially, the focus was on implementing core features and ensuring mobile responsiveness, which involved extensive frontend CSS modifications and debugging login issues related to environment variables and database configuration. Subsequent phases addressed user-reported bugs, such as translation inconsistencies and  component  errors, implementing recommended Shadcn UI patterns. A significant portion of the work then shifted to new feature development, including a balance top-up system for sub-agencies, a comprehensive deployment guide for a self-hosted VPS, and a major multi-faceted request encompassing Expenses and Requests pages, conversation threads, document uploads, and dynamic status icons. The AI navigated complex backend (FastAPI, MongoDB) and frontend (React, Shadcn UI) changes, including critical balance deduction logic and extensive internationalization updates, often debugging and refining in response to user feedback and console errors. The trajectory concludes with the AI actively working on the latest user requests, including further translations, backend model updates for top-ups, and a custom button-style selector.
</analysis>

<product_requirements>
The goal is a bilingual (RU default, EN optional) B2B travel portal for an Admin (travel wholesaler) and Sub-agencies (clients). Sub-agencies view reservations, payments, balances, and manage travel requests. Admin has full CRUD access, managing sub-agencies, reservations, suppliers, tourists, and expenses.

**Implemented features:**
- User authentication (email + password) with RBAC (Admin/Sub-agency roles).
- Reservations Dashboard: filters, sort, pagination, XLSX export, payment statuses, display without admin-only columns for sub-agencies.
- Reservation Details: view details (read-only for sub-agency, edit/mark paid for admin).
- Sub-Agencies: CRUD management (phone, editable email).
- Settings: Configure upcoming due threshold.
- Supplier and Tourist management pages (Admin).
- Custom color palette, Ruble currency (no decimals), dd.mm.yyyy date format, striped tables.
- Mobile responsiveness (hamburger menu, bottom navigation, adaptive layouts, horizontal table scroll).
- Translation support for Поставщики/Туристы menu items.
- Fixed Shadcn UI  component  issues using  and , and global .
- **Balance System**:
    - Admin can add balance to sub-agencies (with Type: Cash/Other).
    - Sub-agencies see their balance and last top-up in Dashboard.
    - Reservations and Expenses deduct from agency balance (can go negative).
    - Top-ups history page for Admin.
- **Expenses Page**: Admin adds expenses (agency, amount, date, description); agencies view their own expenses. Total expenses displayed in Dashboard.
- **Service Types**: Added MICE, Event, Other, excursion, insurance.
- **Requests Page**:
    - Agencies create travel requests (check-in/out, Pax, Flight class, Transfer, Country, Location, Hotel, Category, Meal, Description, Target Price).
    - Agencies view their requests.
    - Admin views all requests (list with filters, striped table).
    - Request details page for Admin/Agency with conversation thread (comments).
    - Document upload (Admin) and download (Agency); document status automatically Documents ready on upload.
- **Status Icons**: Reservation, Payment, and Document statuses displayed as icons with tooltips.
- Improved striped row visibility.
- Deployment support for Ubuntu 22.04 VPS with Docker, Nginx, PM2 (Dockerfiles, compose, Nginx configs, deploy scripts, deployment guide).
</product_requirements>

<key_technical_concepts>
- **FastAPI**: Python backend for robust API development.
- **React**: JavaScript library for dynamic user interfaces.
- **MongoDB**: NoSQL database for flexible data storage.
- **Shadcn UI**: Component library leveraging Radix UI for accessible and customizable components.
- **Tailwind CSS**: Utility-first CSS framework for rapid styling.
- **Internationalization (i18n)**: Bilingual support (Russian, English) via  and .
- **Role-Based Access Control (RBAC)**: Differentiating Admin and Sub-Agency roles at the API level.
- **JWT Authentication**: Token-based security for secure API communication.
- **Custom Data Formatting**: Utilities for date (dd.mm.yyyy) and currency (Ruble, no decimals).
- **Docker/Docker Compose**: Containerization for consistent deployment.
- **Nginx**: Reverse proxy and static file serving for production.
</key_technical_concepts>

<code_architecture>

-   : Main FastAPI app. Defines API for Auth, Users, Reservations, Suppliers, Tourists, Settings, **Expenses**, and **Requests**. Contains MongoDB models (User, Reservation, Supplier, Tourist, **Expense, Request, RequestComment, Document**), CRUD operations, RBAC, payment/document status calculation, data serialization, and **balance deduction/restoration logic for reservations and expenses**. Critical imports were moved to the top.
-   : Environment variables for database URL/name, CORS, JWT_SECRET_KEY.  was updated to .
-   : Configures React routing, integrating new pages (, , , ).
-   : Global styles. Added  to  to stabilize scrollbars.
-   : Application layout. Updated for mobile responsiveness (hamburger menu, bottom navigation), and included  and  in navigation.
-   : Central reservations list. Updated for mobile responsiveness, currency/date formatting, striped rows, and displays new **Total Expenses** and **Balance/Last Top-up** cards.  constant was expanded.
-   : Displays detailed reservation info. Updated for mobile responsiveness, fixed select box issues.
-   : Admin page for managing sub-agencies. Updated for mobile responsiveness, added **Balance column, Top-up button and dialog**.
-   , : Admin pages, updated for mobile responsiveness and fixed select box issues.
-   : **New page for Admin/Agencies**. Admin adds expenses; agencies view their own.
-   : **New page for Admin/Agencies**. Agencies create and view requests; admin views all requests, includes filters, and dynamic status display.
-   : **New page for Admin/Agencies**. Displays detailed request info, supports **conversation threads (comments)**, **document upload/download**, and dynamic status updates.
-   : Manages internationalization. Expanded significantly for new pages, features, and detailed status messages.
-   : **New component** for displaying reservation, payment, and document statuses as icons with tooltips, supporting both horizontal and vertical layouts.
-   , : Shadcn UI components.  was modified for  and collision avoidance to fix reflow issues.
-   **Deployment Files**: Multiple new Docker, docker-compose, Nginx, and shell scripts (, , , , , , , , , , , , ) were created at the root level for VPS deployment.
</code_architecture>

<pending_tasks>
-   **Admin: Assign Reservations**: Implement functionality for administrators to assign existing reservations to specific sub-agencies.
-   **Admin: CSV/Excel Import**: Develop feature for administrators to import reservations via CSV/Excel files.
-   **Admin: Add New Supplier Inline**: Implement the + button functionality near the supplier selectbox to allow admins to add new suppliers directly from the Add Reservation form.
-   **Admin: Tourist Name Autocompletion**: Implement autocompletion for tourist names when adding new reservations.
-   **Top ups page**: Create an Admin page to see and edit all top-up transactions.
-   **Dashboard cards for this month**: Add this month numbers to all existing dashboard statistics cards.
-   **Agency balance in profile menu**: Display the agency's current balance in the profile menu.
-   **Custom button-style selector**: Change select boxes with fewer than 6 elements to a button-style selector with colored lines when selected.
</pending_tasks>

<current_work>
The AI engineer is currently addressing the user's latest set of requests. This includes:
1.  **Fixing status translations**: Reconfirming and separating appropriate status translations for Russian and English. The AI observed that some of these changes were already applied.
2.  **Adding translations for Top-ups page**: Updating the  file to include necessary terms for the upcoming Top-ups feature.
3.  **Updating SubAgencies translations**: Further refining translations related to sub-agencies.
4.  **Backend updates for Top-ups history**: The AI is preparing to modify the backend to include a  field (Cash/Other) in the  model, which will support tracking different types of balance top-ups for the new Top ups page. This indicates a focus on laying the backend foundation for the new  feature.
5.  **Implementing custom button-style selector**: The user explicitly requested to change select boxes with fewer than 6 elements to a button-style selector, and the AI has accepted this task.
</current_work>

<optional_next_step>
Continue implementing the backend updates to the  model by adding the  field.
</optional_next_step>
